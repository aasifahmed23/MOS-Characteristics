function [Ids,Vth] = N_18_MM_V2(Vgs,Vds,Vbs,W,L)
%% NMOS model card
%% Refer pg# 161 of BSIM4.3.0 MOSFET Model here : https://cmosedu.com/cmos1/BSIM4_manual.pdf
TNOM    = 27 ;
TOX     = 4.1E-9;
XJ      = 1E-7; 
NCH     = 2.3549E17;
VTH0    = 0.3725327;
K1      = 0.5933684;
K2      = 2.050755E-3;
K3      = 1E-3;
K3B     = 4.5116437;
W0      = 1E-7;
NLX     = 1.870758E-7;
DVT0W   = 0;
DVT1W   = 0;
DVT2W   = 0;
DVT0    = 1.3621338;
DVT1    = 0.3845146;
DVT2    = 0.0577255;
U0      = 259.5304169;
UA      = -1.413292E-9;
UB      = 2.229959E-18;
UC      = 4.525942E-11;
VSAT    = 9.411671E4;
A0      = 1.7572867;
AGS     = 0.3740333;
B0      = -7.087476E-9;
B1      = -1E-7;
KETA    = -4.331915E-3; 
A1      = 0;
A2      = 1;
RDSW    = 111.886044;
PRWG    = 0.5;
PRWB    = -0.2;
WR      = 1;
WINT    = 0;    
LINT    = 1.701524E-8;
XL      = 0;
XW      = -1E-8;
DWG     = -1.365589E-8;
DWB     = 1.045599E-8;
VOFF    = -0.0927546;
NFACTOR = 2.4494296;
CIT     = 0; 
CDSC    = 2.4E-4;
CDSCD   = 0;
CDSCB   = 0;
ETA0    = 3.175457E-3;
ETAB    = 3.494694E-5;
DSUB    = 0.0175288;
PCLM    = 0.7273497;  
PDIBLC1 = 0.1886574;
PDIBLC2 = 2.617136E-3; 
PDIBLCB = -0.1; 
DROUT   = 0.7779462;
PSCBE1  = 3.488238E10;
PSCBE2  = 6.841553E-10;  
PVAG    = 0.0162206;
DELTA   = 0.01;
RSH     = 6.5; 
MOBMOD  = 1;
PRT     = 0;
UTE     = -1.5;
KT1     = -0.11;
KT1L    = 0;
KT2     = 0.022;
UA1     = 4.31E-9;
UB1     = -7.61E-18; 
UC1     = -5.6E-11;
AT      = 3.3E4;
WL      = 0;
WLN     = 1;  
WW      = 0;
WWN     = 1;
WWL     = 0;
LL      = 0;
LLN     = 1;
LW      = 0;
LWN     = 1;
LWL     = 0;
CAPMOD  = 2;
XPART   = 0.5;
CGDO    = 8.53E-10;
CGSO    = 8.53E-10;    
CGBO    = 1E-12;
CJ      = 9.513993E-4;   
PB      = 0.8;
MJ      = 0.3773625;
CJSW    = 2.600853E-10;
PBSW    = 0.8157101;
MJSW    = 0.1004233;
CJSWG   = 3.3E-10;
PBSWG   = 0.8157101;
MJSWG   = 0.1004233;
CF      = 0;     
PVTH0   = -8.863347E-4;   
PRDSW   = -3.6877287;
PK2     = 3.730349E-4; 
WKETA   = 6.284186E-3;
LKETA   = -0.0106193;
PU0     = 16.6114107;  
PUA     = 6.572846E-11; 
PUB     = 0;
PVSAT   = 1.112243E3;  
PETA0   = 1.002968E-4;    
PKETA   = -2.906037E-3;

% % %% PMOS Model Card
% % TNOM    = 27;
% % TOX     = 4.1E-9;
% % XJ      = 1E-7;
% % NCH     = 4.1589E17;
% % VTH0    = -0.3948389;
% % K1      = 0.5763529;
% % K2      = 0.0289236;
% % K3      = 0;
% % K3B     = 13.8420955;
% % W0      = 1E-6;
% % NLX     = 1.337719E-7;
% % DVT0W   = 0;
% % DVT1W   = 0;
% % DVT2W   = 0;
% % DVT0    = 0.5281977;
% % DVT1    = 0.2185978;
% % DVT2    = 0.1;
% % U0      = 109.9762536;
% % UA      = 1.325075E-9;
% % UB      = 1.577494E-21;
% % UC      = -1E-10;
% % VSAT    = 1.910164E5;
% % A0      = 1.7233027;
% % AGS     = 0.3631032;
% % B0      = 2.336565E-7;
% % B1      = 5.517259E-7;
% % KETA    = 0.0217218;
% % A1      = 0.3935816;
% % A2      = 0.401311;
% % RDSW    = 252.7123939;
% % PRWG    = 0.5;
% % PRWB    = 0.0158894;
% % WR      = 1;
% % WINT    = 0;
% % LINT    = 2.718137E-8;
% % XL      = 0;
% % XW      = -1E-8;
% % DWG     = -4.363993E-8;
% % DWB     = 8.876273E-10;
% % VOFF    = -0.0942201;
% % NFACTOR = 2;
% % CIT     = 0;
% % CDSC    = 2.4E-4;
% % CDSCD   = 0;
% % CDSCB   = 0;
% % ETA0    = 0.2091053;
% % ETAB    = -0.1097233;
% % DSUB    = 1.2513945;
% % PCLM    = 2.1999615;
% % PDIBLC1 = 1.238047E-3;
% % PDIBLC2 = 0.0402861;
% % PDIBLCB = -1E-3;
% % DROUT   = 0;
% % PSCBE1  = 1.034924E10;
% % PSCBE2  = 2.991339E-9;
% % PVAG    = 15;
% % DELTA   = 0.01;
% % RSH     = 7.5;
% % MOBMOD  = 1;
% % PRT     = 0;
% % UTE     = -1.5;
% % KT1     = -0.11;
% % KT1L    = 0;
% % KT2     = 0.022;
% % UA1     = 4.31E-9;
% % UB1     = -7.61E-18;
% % UC1     = -5.6E-11;
% % AT      = 3.3E4;
% % WL      = 0;
% % WLN     = 1;
% % WW      = 0;
% % WWN     = 1;
% % WWL     = 0;
% % LL      = 0;
% % LLN     = 1;
% % LW      = 0;
% % LWN     = 1;
% % LWL     = 0;
% % CAPMOD  = 2;
% % XPART   = 0.5;
% % CGDO    = 6.28E-10;
% % CGSO    = 6.28E-10;
% % CGBO    = 1E-12;
% % CJ      = 1.160855E-3;
% % PB      = 0.8484374;
% % MJ      = 0.4079216;
% % CJSW    = 2.306564E-10;
% % PBSW    = 0.842712;
% % MJSW    = 0.3673317;
% % CJSWG   = 4.22E-10;
% % PBSWG   = 0.842712;
% % MJSWG   = 0.3673317;
% % CF      = 0;
% % PVTH0   = 2.619929E-3;
% % PRDSW   = 1.0634509;
% % PK2     = 1.940657E-3;
% % WKETA   = 0.0355444;
% % LKETA   = -3.037019E-3;
% % PU0     = -1.0227548;
% % PUA     = -4.36707E-11;
% % PUB     = 1E-21;
% % PVSAT   = -50;
% % PETA0   = 1E-4;
% % PKETA   = -5.167295E-3;
% % %% Bias voltages
% % Vgs=0.55;
% % Vds=0.9;
% % Vbs=0.4;
% % %% Device sizes
% % W=(2e-6);
% % L=(0.72E-6);
Wdrawn=W;
Ldrawn=L;
%% Physical constants
kb=1.3806503e-23;
q=1.602176462e-19;
ephsilon_si=4.1;
ephsilon_knot=8.854187817e-12;
Vtmo=kb*TNOM/q;
Eg0=1.16-((7.02E-4)*TNOM^2/(TNOM+1108));
ni=(1.45e10)*((TNOM/300.15)^1.5)*exp(21.5565981-Eg0/(2*Vtmo));
Phi_s=2*Vtmo*log(NCH/ni);
%% Calc Threshold Voltage
T=TNOM;
Vt=Vtmo*T/TNOM;
Nds=1e20;
Vbi=Vt*log(NCH*Nds/ni^2);
Vbc=0.9*(Phi_s-(K1^2)/(4*K2^2));
delta1=0.001;
Vbs_eff=Vbc+0.5*(Vbs-Vbc-delta1+sqrt((Vbs-Vbc-delta1).^2 -4*delta1*Vbc)); %%%MATRIX
Xdep0=sqrt(2*ephsilon_si*Phi_s/(q*NCH));
Xdep=sqrt(2*ephsilon_si*(Phi_s-Vbs_eff)/(q*NCH));  %%%MATRIX
Cox=(ephsilon_si*ephsilon_knot)/TOX;
l_to=sqrt(ephsilon_si*Xdep0/Cox);
l_t_o=sqrt(ephsilon_si*Xdep/Cox); %%%MATRIX
l_tw=l_t_o.*(1+DVT2W.*Vbs_eff); %%%MATRIX
l_t=l_t_o.*(1+DVT2.*Vbs_eff); %%%MATRIX
TOXM=TOX;
K1_ox=K1*TOX/TOXM;
K2_ox=K2*TOX/TOXM;
Vth0_ox=VTH0-K1*sqrt(Phi_s);
%bifurcate Vth calc for Effective channel Length and Width (dW dL)  calc
dL=LINT+LL./L.^LLN+LW./W.^LWN+LWL./((L.^LLN).*(W.^LWN)); %%%MATRIX
dW_dash=WINT+WL./L.^WLN+WW./W.^WWN+WWL./((L.^WLN).*(W.^WWN)); %%%MATRIX
Leff=Ldrawn-2*dL; %%%MATRIX
Weff_dash=Wdrawn-2*dW_dash; %%%MATRIX
%bifurcate dL dW calc & Calc Vgst_eff
Cd=ephsilon_si./Xdep; %%%MATRIX
eta=1+NFACTOR*(Cd./Cox)+(CDSC+CDSCD.*Vds+CDSCB.*Vbs_eff).*(exp(-DVT1*Leff./(2*l_t))+2.*exp(-DVT1*Leff./l_t))./Cox+CIT./Cox; %%%MATRIX
%resume Vth calc
Vth=Vth0_ox+K1_ox*sqrt(Phi_s-Vbs_eff)-K2_ox*Vbs_eff; %%%MATRIX
Vth=Vth+K1_ox*(sqrt(1+NLX./Leff)-1)*sqrt(Phi_s)+(K3+K3B*Vbs_eff)*TOX*Phi_s./(Weff_dash+W0); %%%MATRIX
Vth=Vth-DVT0W*(exp(-DVT1W*Weff_dash.*Leff./(2*l_tw))+2*exp(-DVT1W*Weff_dash.*Leff./l_tw))*(Vbi-Phi_s);%%%MATRIX
Vth=Vth-DVT0*(exp(-DVT1*Leff./(2*l_t))+2*exp(-DVT1*Leff./l_t))*(Vbi-Phi_s);%%%MATRIX
Vth=Vth-(exp(-DSUB*Leff./(2.*l_to))+2*exp(-DSUB*Leff/l_to)).*(ETA0+ETAB*Vbs_eff).*Vds;%%%MATRIX
Vgst_eff=2*eta*Vt*log(1+exp((Vgs-Vth)/(2*eta*Vt)))./(1+2*eta*Cox*sqrt(2*Phi_s/(q*ephsilon_si*NCH))*exp(-(Vgs-Vth-2*VOFF)/(2*eta*Vt)));%%%MATRIX
%resume dL dW calc
dW=dW_dash+DWG*Vgst_eff+DWB*(sqrt(Phi_s-Vbs_eff)-sqrt(Phi_s));%%%MATRIX
% Leff=Ldrawn-2*dL;
Weff=Wdrawn-2*dW; %%%MATRIX
%% Mobility for Mobmod=1
mu_eff=U0./(1+(UA+UC*Vbs_eff).*((Vgst_eff+2*Vth)/TOX)+UB*((Vgst_eff+2*Vth)/TOX).^2); %%%MATRIX
%% Source/Drain Resistance Rds
Rds=RDSW*(1+PRWG*Vgst_eff+PRWB*(sqrt(Phi_s-Vbs_eff)-sqrt(Phi_s)))/(Weff_dash*1e6).^WR; %%%MATRIX
%% Drain Saturation Voltage Vdsat
Lambda=A1*Vgst_eff+A2; %%%MATRIX
Esat=2*VSAT./mu_eff; %%%MATRIX
% Find Abulk %%%MATRIX
Abulk=(1+(K1_ox./(2*sqrt(Phi_s-Vbs_eff))).*((A0*Leff./(Leff+2*sqrt(XJ*Xdep))).*(1-AGS*Vgst_eff.*(Leff./(Leff+2*sqrt(XJ*Xdep))).^2)+ B0./(B1+Weff_dash)))./(1+KETA*Vbs_eff);
if (Rds>0)
a=(Abulk.^2).*Weff*VSAT*Cox.*Rds+(1./Lambda -1).*Abulk;
b=-((Vgst_eff+2*Vt).*(2./Lambda -1)+Abulk.*Esat.*Leff+3*Abulk.*(Vgst_eff+2*Vt).*Weff.*VSAT.*Cox.*Rds);
c=(Vgst_eff+2*Vt).*Esat.*Leff+2*Weff.*VSAT*Cox.*Rds.*(Vgst_eff+2*Vt).^2;
Vdsat=(-b-sqrt(b.^2-4*a.*c))./(2*a);
else
   Vdsat=Esat*Leff*(Vgst_eff+2*Vt)/(Abulk*Esat*Leff+(Vgst_eff+2*Vt)); %%%MATRIX
end
%% Effective Vds
% DELTA=0.01;%effective Vds parameter
Vds_eff=Vdsat-0.5*(Vdsat-Vds-DELTA+sqrt((Vdsat-Vds-DELTA).^2+4*DELTA*Vdsat)); %%%MATRIX
%% Drain Current Expression
litl=sqrt(ephsilon_si*TOX*XJ/ephsilon_knot);
VAsat=(Esat.*Leff+Vdsat+2*Rds.*VSAT.*Cox.*Weff.*Vgst_eff.*(1-Abulk.*Vdsat*0.5./(Vgst_eff+2*Vt)))/(2./Lambda-1+Rds.*VSAT.*Cox.*Weff.*Abulk);
VASCBE=(Leff/PSCBE2).*exp(PSCBE1*litl./(Vds-Vds_eff));
THETA_ROUT=PDIBLC2+PDIBLC1*(exp(-DROUT*Leff/(2*l_to))+2*exp(-DROUT*Leff/l_to));
VADIBLC=((Vgst_eff+2*Vt)./(THETA_ROUT.*(1+PDIBLCB.*Vbs_eff))).*(1-Abulk.*Vdsat./(Abulk.*Vdsat+Vgst_eff+2*Vt));
VACLM=(Abulk.*Esat.*Leff+Vgst_eff).*(Vds-Vds_eff)./(PCLM*Abulk.*Esat*litl);
VA=VAsat+(1+PVAG*Vgst_eff./(Esat.*Leff))./(1./VACLM +1./VADIBLC);
Idso=Weff.*mu_eff.*Cox.*Vgst_eff.*Vds_eff.*(1-Abulk.*Vds_eff.*0.5./(Vgst_eff+2*Vt))./(Leff.*(1+Vds_eff./(Esat.*Leff)));
Ids=(Idso./(1+Rds.*Idso./Vds_eff)).*(1+(Vds-Vds_eff)./VA).*(1+(Vds-Vds_eff)./VASCBE);  
%% Substrate Current
alpha0=0; %first parameter of impact ionization current
alpha1=0.0;% Isub parameter for length scaling
beta0=30;% second parameter of impact ionization current
Isub=((alpha0+alpha1.*Leff).*(Vds-Vds_eff)./Leff).*(Idso./(1+Rds.*Idso./Vds_eff)).*(1+(Vds-Vds_eff)./VA).*exp(-beta0./(Vds-Vds_eff));
%% Temperature Effects
Vth_T=Vth+(KT1+KT1L./Leff+KT2*Vbs_eff).*(T/TNOM-1);
U0_T=U0*(T/TNOM)^UTE;
VSAT_T=VSAT-AT*(T/TNOM-1);
RDSW_T=RDSW+PRT*(T/TNOM-1);
UA_T=UA+UA1*(T/TNOM-1);
UB_T=UB+UB1*(T/TNOM-1);
UC_T=UC+UC1*(T/TNOM-1);
% Find Abulk_dash
Abulk0=(1+(K1_ox./(2*sqrt(Phi_s-Vbs_eff))).*(A0*Leff./(Leff+2*sqrt(XJ*Xdep))+B0./(B1+Weff_dash)))./(1+KETA*Vbs_eff);
CLC=1e-7;%const term for short channel model
CLE=0.6;%exponential term for short channel model
Abulk_dash=Abulk0.*(1+(CLC./Leff).^CLE);

